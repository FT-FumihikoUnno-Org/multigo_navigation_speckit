# Docker Compose (Development overrides)
# This file is intended for DEVELOPMENT / LOCAL TESTING only.
# - Use together with the main `docker-compose.yml` when you need dev-only services like the dummy auth server.
# - Example: `docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build`

version: '3.8'

services:
  # Dummy OIDC authentication server for local development/testing only
  dummyauth:
    image: node:18-alpine
    working_dir: /app
    ports:
      - "3001:3001"
    volumes:
      - ./webapp/src/dummyauth:/app
      - /app/node_modules
    environment:
      OIDC_EXTERNAL_ISSUER: http://dummyauth:3001
    command: sh -c "npm install --no-audit --no-fund --silent && npm run build && node dist/dummyServer.js"
    depends_on:
      - backend
    # Note: this service MUST NOT be included in production deployments.

  # Ensure backend calls the dev issuer via the compose service name and browser redirects go to host
  backend:
    environment:
      OIDC_ISSUER_URL: http://dummyauth:3001
      OIDC_EXTERNAL_ISSUER: http://dummyauth:3001
      OIDC_CLIENT_ID: my-dummy-client-id
      OIDC_CLIENT_SECRET: my-dummy-client-secret
      OIDC_REDIRECT_URI: http://nginx/auth/openid/callback
      FRONTEND_URL: http://nginx

  # Playwright E2E runner service (CI-like; preinstalls browsers via Dockerfile.e2e)
  e2e:
    build:
      context: ./webapp
      dockerfile: Dockerfile.e2e
    volumes:
      - ./webapp:/app:cached
      - ./webapp/playwright-report:/app/playwright-report
    depends_on:
      - nginx
      - backend
      - dummyauth
    environment:
      # Tests should point at the nginx reverse proxy (same-origin dev)
      E2E_BASE_URL: http://nginx
    # The test runner will override the command when invoked (e.g., `npm run e2e:test`).
    command: sleep infinity
